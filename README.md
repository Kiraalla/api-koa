# Shop API 项目说明文档

## 项目概述

本项目是一个基于Koa.js和TypeScript构建的电商API服务，采用分层架构设计，支持多端适配（H5、小程序等），并实现了完整的用户、商品、订单管理功能。

## 项目架构

### 核心技术栈

- **框架**: Koa.js
- **语言**: TypeScript
- **数据库**: MySQL (通过配置支持其他数据库)
- **认证**: JWT (JSON Web Token)
- **API文档**: 独立的api-doc.md文件

### 分层架构

项目采用经典的分层架构，各层职责明确：

1. **路由层** (routes/)
   - 处理HTTP请求路由
   - 参数验证
   - 权限控制

2. **适配器层** (adapter/)
   - 处理多端适配逻辑
   - 支持H5和小程序等不同客户端
   - 统一接口响应格式

3. **模型层** (models/)
   - 数据模型定义
   - 数据库操作封装
   - 业务逻辑处理

4. **中间件层** (middleware/)
   - 错误处理
   - 请求速率限制
   - 参数验证

5. **工具层** (utils/)
   - 通用工具函数
   - 认证相关功能

## 目录结构说明

```
├── .env                 # 环境变量配置
├── api-doc.md           # API接口文档
├── logs/                # 日志文件目录
├── src/                 # 源代码目录
│   ├── adapter/         # 多端适配器
│   ├── config/          # 项目配置
│   ├── middleware/      # 中间件
│   ├── models/          # 数据模型
│   ├── routes/          # 路由定义
│   ├── types/           # 类型定义
│   ├── utils/           # 工具函数
│   └── app.ts           # 应用入口
├── package.json         # 项目依赖
└── tsconfig.json        # TypeScript配置
```

## 核心模块说明

### 1. 适配器模式 (adapter/)

适配器模式用于处理不同客户端的请求差异：

- `adapter.factory.ts`: 适配器工厂，根据客户端类型创建对应适配器
- `h5.adapter.ts`: H5端适配器
- `miniprogram.adapter.ts`: 小程序适配器

### 2. 中间件 (middleware/)

- `error.ts`: 统一错误处理
- `ratelimit.ts`: 请求速率限制
- `validator.ts`: 请求参数验证

### 3. 数据模型 (models/)

- `user.ts`: 用户模型
- `product.ts`: 商品模型
- `order.ts`: 订单模型

## 开发规范

### 1. 新功能开发流程

1. 在`models/`中定义数据模型
2. 在`routes/`中添加路由
3. 根据需要在`middleware/`中添加中间件
4. 更新`api-doc.md`文档

### 2. 适配器开发

添加新的客户端支持：

1. 在`adapter/`目录创建新的适配器类
2. 实现`types.ts`中定义的接口
3. 在`adapter.factory.ts`中注册新适配器

### 3. 错误处理

- 使用统一的错误处理中间件
- 在`types/`中定义错误类型
- 确保错误信息规范化

### 4. 安全性考虑

- 所有敏感配置使用环境变量
- 实施请求速率限制
- 使用JWT进行身份验证
- 参数验证和转义

## 注意事项

1. **环境变量**
   - 开发前复制`.env.example`为`.env`
   - 不要提交`.env`到版本控制

2. **日志处理**
   - 错误日志记录在`logs/error.log`
   - 综合日志记录在`logs/combined.log`

3. **性能优化**
   - 合理使用数据库索引
   - 实现缓存机制
   - 避免大量同步操作

4. **代码规范**
   - 遵循TypeScript规范
   - 使用ESLint进行代码检查
   - 编写单元测试

## 扩展建议

1. **添加新的业务模块**
   - 遵循现有的分层架构
   - 保持代码结构一致性
   - 更新相关文档

2. **性能优化**
   - 实现数据缓存
   - 优化数据库查询
   - 添加性能监控

3. **安全性增强**
   - 实现更复杂的认证机制
   - 添加请求加密
   - 增强参数验证

## 常见问题

1. **启动失败**
   - 检查环境变量配置
   - 确认数据库连接
   - 查看错误日志

2. **性能问题**
   - 检查数据库查询
   - 查看日志中的慢查询
   - 优化代码逻辑

3. **适配器问题**
   - 确认客户端类型
   - 检查适配器实现
   - 查看请求日志

## 贡献指南

1. Fork项目
2. 创建特性分支
3. 提交变更
4. 推送到分支
5. 创建Pull Request

## 版本控制

使用Git进行版本控制，遵循语义化版本规范。

## 许可证

[MIT License](LICENSE)